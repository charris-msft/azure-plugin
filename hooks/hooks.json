{
  "description": "Azure MCP plugin hooks for auto-enabling MCP server, Docker auto-start, azd handling, ACR fallback, and CLI tool installation",
  "hooks": {
    "UserPromptSubmit": [
      {
        "matcher": "(?i)(azure|storage account|blob|cosmos|keyvault|key vault|app service|aks|kubernetes|resource group|subscription|arm template|bicep|azure sql|redis cache|ai search|cognitive|container app|deploy)",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "The user's prompt mentions Azure services. Check if Azure MCP tools (like azure_subscription_list) are available. If Azure MCP tools are NOT available, add a brief systemMessage reminding the user: 'Tip: Enable the Azure MCP server via /mcp for direct Azure access, or run /azure:setup for guided configuration.' If Azure MCP tools ARE available, return an empty JSON object {}. Output ONLY valid JSON with optional systemMessage field, nothing else."
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "Check the Bash output for these error patterns:\n\n1. DOCKER ERRORS: 'docker daemon is not running', 'Cannot connect to the Docker daemon', 'failed to connect to the docker API', 'dockerDesktopLinuxEngine', 'The system cannot find the file specified' (docker context), 'Is the docker daemon running'.\n\n2. AZD SUBSCRIPTION ERRORS: 'is not an allowed choice. allowed choices:', 'Select an Azure Subscription', 'reading subscription id'.\n\n3. AZD INTERACTIVE/ENVIRONMENT ERRORS: 'environment name' AND 'is invalid', 'Enter a unique environment name', 'Enter a new environment name'.\n\n4. ACR TASKS DISABLED: 'ACR Tasks is not supported', 'TasksOperationsNotAllowed', 'Feature not available'.\n\n5. CLI NOT FOUND: \"'az' is not recognized\", \"az: command not found\", \"'azd' is not recognized\", \"azd: command not found\", \"'docker' is not recognized\", \"docker: command not found\", \"'func' is not recognized\", \"func: command not found\".\n\n6. ACR/IMAGE PULL ERRORS: 'unauthorized: authentication required', 'ImagePullBackOff', 'ErrImagePull', 'manifest unknown'.\n\nIf DOCKER error found, return: {\"decision\": \"block\", \"reason\": \"DOCKER ERROR: Use AskUserQuestion to ask 'Docker Desktop isn't running. Would you like me to start it?' If yes, run the platform command to start Docker, wait for ready, then retry.\"}.\n\nIf AZD SUBSCRIPTION error found, return: {\"decision\": \"block\", \"reason\": \"AZD SUBSCRIPTION ERROR: DO NOT show the user that error. Instead: 1) Run 'az account list --query [].{Name:name,ID:id} -o table' to get a clean subscription list, 2) Use AskUserQuestion to ask which subscription to use, 3) Run 'azd env set AZURE_SUBSCRIPTION_ID <id>', 4) Retry with --no-prompt.\"}.\n\nIf AZD INTERACTIVE/ENVIRONMENT error found, return: {\"decision\": \"block\", \"reason\": \"AZD INTERACTIVE ERROR: STOP - azd is waiting for interactive input. FIX: 1) Use AskUserQuestion to ask user for environment name, 2) Run 'azd env new <name> --no-prompt', 3) Set AZURE_SUBSCRIPTION_ID and AZURE_LOCATION, 4) Retry with --no-prompt.\"}.\n\nIf ACR TASKS DISABLED error found, return: {\"decision\": \"block\", \"reason\": \"ACR TASKS DISABLED: This subscription doesn't support cloud builds. FALLBACK: 1) Build locally with 'docker build -t ACR.azurecr.io/app:tag .', 2) Login with 'az acr login --name ACR', 3) Push with 'docker push ACR.azurecr.io/app:tag'. Tell the user this is common on free/trial subscriptions.\"}.\n\nIf CLI NOT FOUND error found, return: {\"decision\": \"block\", \"reason\": \"CLI TOOL MISSING: Use AskUserQuestion to ask 'I detected [TOOL] is not installed. Would you like me to install it?' If yes, run the appropriate winget/brew install command. For Windows: winget install Microsoft.AzureCLI / Microsoft.Azd / Docker.DockerDesktop. Verify installation after.\"}.\n\nIf ACR/IMAGE PULL error found, return: {\"decision\": \"block\", \"reason\": \"ACR CREDENTIAL ERROR: Container Apps cannot pull from ACR. FIX: Run 'az containerapp registry set --name APP -g RG --server ACR.azurecr.io --identity system' to configure managed identity access.\"}.\n\nIf no errors match, return {}. Output ONLY valid JSON."
          }
        ]
      }
    ]
  }
}
